

<% if logged_in?%>

    <div class="container">
        <%= form_with(model: @order, local: true, id:"payment-form")  do |f| %>

            <%= f.hidden_field :amount, :value => @total*100%>
            <%= f.hidden_field :currency, :value => "usd"%>
            <%= f.hidden_field :user_id, :value => current_user.id%>

            <div class= 'row margin-top'>
                <div class= "col-md-3 offset-md-3">
                    <strong> Shipping Address </strong>
                </div>
                <div class="col-4">
                    <%= f.collection_select :shipping_address_id, @addresses.order(:address_line_1), :id, :address_line_1, {}, {class: "form-control"}%>
                    <br> <br>
                    <%= link_to "Add New Address", new_address_path%>
                </div>
            </div>

            <hr>
            
            <div class= 'row'>
                <div class= "col-md-3 offset-md-3">
                    <strong> Payment Method </strong>
                    <br> <br>
                    <div class="padding-sides gray-border"id="card-element">
                        <!-- Elements will create input elements here -->
                    </div>

                    <!-- We'll put the error messages in this element -->
                    <div id="card-errors" role="alert"></div>

                </div>
                <div class="col-4">
                    <strong> Billing Address </strong>
                    <br> <br>
                    <%= f.collection_select :billing_address_id, @addresses.order(:address_line_1), :id, :address_line_1, {}, {class: "form-control"}%>
                    <br> <br>
                    <%= link_to "Add New Address", new_address_path%>
                    <br> <br>
                </div>
            </div>

            <hr>

            <div class= 'row'>
                <div class= "col-md-7 offset-md-3">
                    <strong> Review your order </strong>
                    <br> <br>
                    <div class="gray-border">
                        <br>
                        <div class="container">
                            <% @cards.each do |card| %>
                                <div class="row h-100 ">
                                    <div class="col-3">
                                        <img class="responsive" src= <%= asset_path(card.img) %> height=250px width=150px/>
                                    </div>
                                    <div class="col-3 my-auto">
                                        <%= card.short_description %>
                                    </div>
                                    <div class="col-3 my-auto">
                                        <%= link_to [get_selection(current_cart, card)], method: :delete do %>
                                            <i class="fas fa-minus"></i>
                                        <% end %>
                                        &nbsp;
                                        <%= @sizes[card.id] %> 
                                        &nbsp;
                                        <%= link_to selections_path(selection: {shopping_cart_id: current_cart.id, card_id: card.id}), method: :post, params: {selection: {shopping_cart_id: current_cart.id, card_id: card.id}} do %> 
                                            <i class="fas fa-plus"></i>
                                        <% end %>
                                    </div>
                                    <div class="col-3 my-auto">
                                        $<%= @sizes[card.id] * 5 %>
                                    </div>
                                </div>
                            <% end %>
                        </div>
                    </div>
                </div>
            </div>

            <br> <br>

            <div class="row margin-bottom">
                <div class="col-md-7 offset-md-3">

                    <div class="container gray-border padding-sides">
                        <div class="row">
                            <div class="col-3 offset-md-1 my-auto">
                                <%= f.submit "Checkout", class: "btn btn-primary"%>
                            </div>
                            <div class="col-7 my-auto">
                                <h4> <strong> Total: $<%= @total%> </strong> </h4>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

        <% end %>
    </div>

<% else %>

    implement this later

<% end %>


<script src="https://js.stripe.com/v3/"></script>
<script>
    // Set your publishable key: remember to change this to your live publishable key in production
    // See your keys here: https://dashboard.stripe.com/account/apikeys
    var stripe = Stripe('pk_test_51GroxnGYhSS9s9rvN6vCJC23mTemFWoKTIXA0ztQ1QJswzi29Qf95PFb9nG6AKjwijEKb4fqvL2MkPeOoCn2s5zY00RAV6TboP');
    var elements = stripe.elements();

    // Set up Stripe.js and Elements to use in checkout form
    var style = {
        base: {
            color: "#32325d",
        }
    };

    var card = elements.create("card", { style: style });
    console.dir(card)
    card.mount("#card-element");


    card.on('change', ({error}) => {
    const displayError = document.getElementById('card-errors');
        if (error) {
            displayError.textContent = error.message;
        } else {
            displayError.textContent = '';
        }
    });

    var form = document.getElementById('payment-form');

    // form.addEventListener('submit', function(ev) {
    //     ev.preventDefault();
    //     stripe.confirmCardPayment(clientSecret, {
    //             payment_method: {
    //             card: card,
    //             billing_details: {
    //                 name: 'Jenny Rosen'
    //             }
    //         }
    //     }).then(function(result) {
    //         if (result.error) {
    //         // Show error to your customer (e.g., insufficient funds)
    //         console.log(result.error.message);
    //         } else {
    //         // The payment has been processed!
    //         if (result.paymentIntent.status === 'succeeded') {
    //             // Show a success message to your customer
    //             // There's a risk of the customer closing the window before callback
    //             // execution. Set up a webhook or plugin to listen for the
    //             // payment_intent.succeeded event that handles any business critical
    //             // post-payment actions.
    //         }
    //         }
    //     });
    // });
</script>